<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="createPlanPage.titleTag">Create Your Plan | Saudi Tourism</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;800;900&family=Tajawal:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="../../styles/main.css" />
    <link rel="stylesheet" href="../../styles/planner.css" />
    <link rel="stylesheet" href="../../styles/chatbot.css" />
    <link rel="icon" type="image/png" href="../../assets/icons/Fav-icon.png" />

    <style>
      /* Override day-cards to display in single column (one day per row) */
      #daysContainer.day-cards {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      #daysContainer.day-cards .day-card {
        width: 100%;
      }

      /* Custom planner place rows */
      .place-row {
        display: grid;
        grid-template-columns: 2fr 1.5fr 1.5fr 1fr auto;
        gap: 10px;
        align-items: end;
        padding: 12px;
        background: var(--color-bg-elevated, var(--color-bg-surface));
        border-radius: 10px;
        border: 1px solid var(--color-border-subtle);
        margin-bottom: 10px;
      }

      .place-row .field {
        min-width: 0;
      }

      .place-row .field label {
        font-size: 0.85rem;
        margin-bottom: 4px;
      }

      .place-row .field input,
      .place-row .field select {
        width: 100%;
        font-size: 0.9rem;
      }

      .place-row button {
        padding: 8px 12px;
        font-size: 0.85rem;
        white-space: nowrap;
        height: fit-content;
      }

      /* Responsive: stack on mobile */
      @media (max-width: 768px) {
        .place-row {
          grid-template-columns: 1fr;
          gap: 12px;
        }

        .place-row button {
          width: 100%;
        }
      }

      /* Responsive: adjust grid on tablet */
      @media (min-width: 769px) and (max-width: 1024px) {
        .place-row {
          grid-template-columns: 2fr 1.5fr 1fr auto;
        }

        .place-row .field:nth-child(3) {
          grid-column: 1 / -1;
        }
      }
    </style>

    <script src="../../scripts/config.js"></script>
    <script type="module" src="../../scripts/modules/i18n.js"></script>
    <script src="../../scripts/chatbot.js" defer></script>
    <script src="../../scripts/header-component.js" defer></script>
  </head>

  <body>
    <!-- Chatbot toggle button -->
    <button id="chatbot-toggler">
      <span class="material-symbols-outlined">mode_comment</span>
      <span class="material-symbols-rounded">close</span>
    </button>

    <!-- Chatbot container -->
    <div class="chatbot-popup">
      <div class="chat-header">
        <div class="header-info">
          <img
            style="width: 50px; border-radius: 1000px"
            src="../../assets/icons/chatbot-icon.png"
            alt="Mutlaq assistant"
          />
          <h2 class="logo-text">Saudi Tourism Bot</h2>
        </div>
        <button id="close-chatbot" class="material-symbols-rounded">
          keyboard_arrow_down
        </button>
      </div>
      <div class="chat-body">
        <div class="message bot-message">
          <img
            style="width: 50px; border-radius: 1000px"
            src="../../assets/icons/chatbot-icon.png"
            alt=""
          />
          <div dir="auto" class="message-text">
            Hello, I'm Mutlaq, your personal assistant in choosing your next
            destination. How can I help you?
          </div>
        </div>
      </div>
      <div class="chat-footer">
        <form action="#" class="chat-form">
          <textarea
            dir="auto"
            placeholder="Ask your question about tourism in Saudi Arabia..."
            class="message-input"
            required
          ></textarea>
          <div class="chat-controls">
            <button
              type="submit"
              id="send-message"
              class="material-symbols-rounded"
            >
              arrow_upward
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Site header -->
    <header id="header" data-header-placeholder></header>

    <main class="page-wrapper">
      <section class="planner-card" aria-labelledby="create-plan-title">
        <div class="planner-header">
          <p class="form-note accent" data-i18n="createPlanPage.accent">Create a new Plan</p>
          <h1 id="create-plan-title" data-i18n="createPlanPage.title">Create a new Saudi plan</h1>
          <p class="form-note" data-i18n="createPlanPage.description">
            ADD A NAME FOR THE PLAN AND HOW MANY DAYS, THEN DESCRIPE EACH DAY </p>
        </div>

        <form id="createPlanForm" novalidate>
          <div class="planner-grid">
            <div class="field">
              <label for="planName" data-i18n="createPlanPage.planNameLabel">Plan name</label>
              <input
                type="text"
                id="planName"
                name="planName"
                data-i18n-placeholder="createPlanPage.planNamePlaceholder"
                placeholder="e.g., Grand 1-Month Saudi Discovery"
                minlength="3"
                maxlength="80"
                required
              />
              <span class="helper-text" data-i18n="createPlanPage.planNameHelper">3–80 characters</span>
            </div>

            <div class="field">
              <label for="planDays" data-i18n="createPlanPage.daysLabel">How many days is your plan</label>
              <input
                type="number"
                id="planDays"
                name="planDays"
                min="1"
                max="30"
                value="7"
                required
              />
              <span class="helper-text" data-i18n="createPlanPage.daysHelper">Between 1 and 30 days</span>
            </div>
          </div>

          <div class="planner-actions">
            <button type="reset" class="btn-secondary" data-i18n="createPlanPage.resetBtn">Reset</button>
            <a href="planner.html" class="btn-secondary" data-i18n="createPlanPage.viewSavedPlansBtn" style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center;">
              View Saved Plans
            </a>
            <button type="button" id="savePlanBtn" class="btn-primary" data-i18n="createPlanPage.savePlanBtn">
              Save Plan
            </button>
          </div>
        </form>

        <div class="day-sections" aria-live="polite" aria-label="Plan days">
          <div class="day-sections__header">
            <div>
              <p class="form-note accent" data-i18n="createPlanPage.dayByDayAccent">Day-by-day planner</p>
              <h2 class="section-title" data-i18n="createPlanPage.dayByDayTitle">Build your custom daily plan</h2>
              <p class="form-note" data-i18n="createPlanPage.dayByDayDesc">
                Add places to visit for each day. For each place, specify the name, category, location, and visit time.
              </p>
            </div>
            <div class="day-meta-chip" id="daysSummary">0 days</div>
          </div>
          <div id="daysContainer" class="day-cards"></div>
        </div>

        <div id="saveStatus" class="status-text" role="status" aria-live="polite"></div>
      </section>
    </main>

    <script type="module" src="../../scripts/main.js"></script>
    <script>
      // Wait for DOM to be ready
      const initCreatePlan = () => {
        const form = document.getElementById("createPlanForm");
        const nameInput = document.getElementById("planName");
        const daysInput = document.getElementById("planDays");
        const daysContainer = document.getElementById("daysContainer");
        const daysSummary = document.getElementById("daysSummary");
        const statusText = document.getElementById("saveStatus");
        const savePlanBtn = document.getElementById("savePlanBtn");

        if (!form || !nameInput || !daysInput || !daysContainer || !savePlanBtn) {
          console.error("Required elements not found:", {
            form: !!form,
            nameInput: !!nameInput,
            daysInput: !!daysInput,
            daysContainer: !!daysContainer,
            savePlanBtn: !!savePlanBtn
          });
          return;
        }

        // Get API URL (same pattern as other pages - uses config.js)
        const getApiUrl = () => {
          return window.API_BASE_URL || "http://127.0.0.1:9000/api";
        };

        // Get auth token
        const getToken = () => {
          return localStorage.getItem("auth_token");
        };

        // Get translation helper
        const getTranslation = (key) => {
          if (window.i18n && typeof window.i18n.t === 'function') {
            return window.i18n.t(key);
          }
          return null;
        };

        const clampDays = (value) => {
          const number = Number(value);
          if (Number.isNaN(number)) return 1;
          return Math.min(30, Math.max(1, number));
        };

        const updateStatus = (message, tone = "muted") => {
          statusText.textContent = message;
          statusText.className = `status-text ${tone}`;
          if (tone === "success") {
            statusText.style.color = "#22c55e";
            statusText.style.backgroundColor = "rgba(34, 197, 94, 0.1)";
            statusText.style.border = "1px solid rgba(34, 197, 94, 0.3)";
            statusText.style.padding = "12px";
            statusText.style.borderRadius = "8px";
            statusText.style.display = "block";
          } else if (tone === "error") {
            statusText.style.color = "#ef4444";
            statusText.style.backgroundColor = "rgba(239, 68, 68, 0.1)";
            statusText.style.border = "1px solid rgba(239, 68, 68, 0.3)";
            statusText.style.padding = "12px";
            statusText.style.borderRadius = "8px";
            statusText.style.display = "block";
          } else {
            statusText.style.display = "block";
          }
        };

        // Create a place input row
        const createPlaceRow = (dayIndex, placeIndex) => {
          const placeRow = document.createElement("div");
          placeRow.className = "place-row";
          // Styles are handled by CSS class

          // Place Name
          const nameField = document.createElement("div");
          nameField.className = "field";
          const nameLabel = document.createElement("label");
          nameLabel.setAttribute("data-i18n", "createPlanPage.placeNameLabel");
          nameLabel.textContent = "Place Name";
          nameLabel.style.fontSize = "0.85rem";
          const nameInput = document.createElement("input");
          nameInput.type = "text";
          nameInput.name = `day-${dayIndex}-place-${placeIndex}-name`;
          nameInput.setAttribute("data-i18n-placeholder", "createPlanPage.placeNamePlaceholder");
          nameInput.placeholder = "e.g., Al-Masjid Al-Haram";
          nameInput.required = true;
          nameField.appendChild(nameLabel);
          nameField.appendChild(nameInput);

          // Category
          const categoryField = document.createElement("div");
          categoryField.className = "field";
          const categoryLabel = document.createElement("label");
          categoryLabel.setAttribute("data-i18n", "createPlanPage.categoryLabel");
          categoryLabel.textContent = "Category";
          categoryLabel.style.fontSize = "0.85rem";
          const categorySelect = document.createElement("select");
          categorySelect.name = `day-${dayIndex}-place-${placeIndex}-category`;
          categorySelect.required = true;
          const categories = [
            { value: "", textKey: "createPlanPage.categorySelect", text: "Select..." },
            { value: "Historical", textKey: "createPlanPage.categoryHistorical", text: "Historical" },
            { value: "Religious", textKey: "createPlanPage.categoryReligious", text: "Religious" },
            { value: "Food/Cafés", textKey: "createPlanPage.categoryFood", text: "Food/Cafés" },
            { value: "Entertainment", textKey: "createPlanPage.categoryEntertainment", text: "Entertainment" }
          ];
          categories.forEach(cat => {
            const option = document.createElement("option");
            option.value = cat.value;
            if (cat.textKey && window.i18n && window.i18n.t) {
              option.setAttribute("data-i18n", cat.textKey);
              option.textContent = window.i18n.t(cat.textKey);
            } else {
              option.textContent = cat.text;
            }
            categorySelect.appendChild(option);
          });
          categoryField.appendChild(categoryLabel);
          categoryField.appendChild(categorySelect);

          // Location
          const locationField = document.createElement("div");
          locationField.className = "field";
          const locationLabel = document.createElement("label");
          locationLabel.setAttribute("data-i18n", "createPlanPage.locationLabel");
          locationLabel.textContent = "Location";
          locationLabel.style.fontSize = "0.85rem";
          const locationInput = document.createElement("input");
          locationInput.type = "text";
          locationInput.name = `day-${dayIndex}-place-${placeIndex}-location`;
          locationInput.setAttribute("data-i18n-placeholder", "createPlanPage.locationPlaceholder");
          locationInput.placeholder = "e.g., Makkah, Saudi Arabia";
          locationField.appendChild(locationLabel);
          locationField.appendChild(locationInput);

          // Visit Time
          const timeField = document.createElement("div");
          timeField.className = "field";
          const timeLabel = document.createElement("label");
          timeLabel.setAttribute("data-i18n", "createPlanPage.visitTimeLabel");
          timeLabel.textContent = "Visit Time";
          timeLabel.style.fontSize = "0.85rem";
          const timeInput = document.createElement("input");
          timeInput.type = "time";
          timeInput.name = `day-${dayIndex}-place-${placeIndex}-time`;
          timeInput.required = true;
          timeField.appendChild(timeLabel);
          timeField.appendChild(timeInput);

          // Remove button
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className = "btn-secondary";
          removeBtn.setAttribute("data-i18n", "createPlanPage.removeBtn");
          removeBtn.textContent = "Remove";
          // Button styles are handled by CSS
          removeBtn.addEventListener("click", () => {
            placeRow.remove();
            updatePlaceCount(dayIndex);
          });

          placeRow.appendChild(nameField);
          placeRow.appendChild(categoryField);
          placeRow.appendChild(locationField);
          placeRow.appendChild(timeField);
          placeRow.appendChild(removeBtn);

          return placeRow;
        };

        // Update place count for a day
        const updatePlaceCount = (dayIndex) => {
          const dayCard = document.querySelector(`[data-day="${dayIndex}"]`);
          if (!dayCard) return;
          const placesContainer = dayCard.querySelector(".places-container");
          const count = placesContainer.querySelectorAll(".place-row").length;
          const countBadge = dayCard.querySelector(".place-count-badge");
          if (countBadge) {
            countBadge.textContent = `${count} place${count === 1 ? "" : "s"}`;
          }
        };

        // Render day sections with custom planner UI
        const renderDaySections = (count) => {
          daysContainer.innerHTML = "";
          daysSummary.textContent = `${count} day${count === 1 ? "" : "s"}`;

          for (let i = 1; i <= count; i += 1) {
            const card = document.createElement("article");
            card.className = "day-card day-card--editable";
            card.setAttribute("data-day", i);
            card.style.cssText = `
              padding: 16px;
              margin-bottom: 20px;
            `;

            // Day header
            const heading = document.createElement("div");
            heading.className = "day-card__heading";
            heading.style.cssText = `
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 16px;
            `;
            const dayChip = document.createElement("div");
            dayChip.className = "day-chip";
            const dayText = (window.i18n && window.i18n.t) ? window.i18n.t("createPlanPage.day") : "Day";
            dayChip.textContent = `${dayText} ${i}`;
            heading.appendChild(dayChip);
            
            const placeCountBadge = document.createElement("div");
            placeCountBadge.className = "place-count-badge";
            placeCountBadge.style.cssText = `
              padding: 4px 10px;
              border-radius: 999px;
              background: var(--color-bg-elevated);
              border: 1px solid var(--color-border-subtle);
              font-size: 0.8rem;
              color: var(--color-text-secondary);
            `;
            placeCountBadge.textContent = "0 places";
            heading.appendChild(placeCountBadge);
            card.appendChild(heading);

            // Places container
            const placesContainer = document.createElement("div");
            placesContainer.className = "places-container";
            placesContainer.style.cssText = `
              margin-bottom: 12px;
            `;
            card.appendChild(placesContainer);

            // Add place button
            const addPlaceBtn = document.createElement("button");
            addPlaceBtn.type = "button";
            addPlaceBtn.className = "btn-secondary";
            addPlaceBtn.setAttribute("data-i18n", "createPlanPage.addPlaceBtn");
            addPlaceBtn.textContent = "+ Add Place";
            addPlaceBtn.style.cssText = `
              width: 100%;
              margin-top: 8px;
            `;
            addPlaceBtn.addEventListener("click", () => {
              const placeRow = createPlaceRow(i, placesContainer.querySelectorAll(".place-row").length + 1);
              placesContainer.appendChild(placeRow);
              updatePlaceCount(i);
            });
            card.appendChild(addPlaceBtn);

            daysContainer.appendChild(card);
          }

          updateStatus(getTranslation("createPlanPage.statusReady") || "Day sections ready. Add places to each day.");
        };

        const handleDaysChange = () => {
          const clamped = clampDays(daysInput.value);
          if (String(clamped) !== daysInput.value) {
            daysInput.value = clamped;
          }
          renderDaySections(clamped);
        };

        // Collect plan data
        const collectPlanData = () => {
          const planName = nameInput.value.trim();
          const days = clampDays(daysInput.value);
          const planDetails = [];

          for (let day = 1; day <= days; day++) {
            const dayCard = document.querySelector(`[data-day="${day}"]`);
            if (!dayCard) continue;

            const places = [];
            const placeRows = dayCard.querySelectorAll(".place-row");

            placeRows.forEach((row) => {
              // Use more specific selectors
              const nameInput = row.querySelector('input[type="text"][name*="-name"]');
              const categorySelect = row.querySelector('select[name*="-category"]');
              const locationInput = row.querySelector('input[type="text"][name*="-location"]');
              const timeInput = row.querySelector('input[type="time"]');

              const name = nameInput?.value.trim();
              const category = categorySelect?.value;
              const location = locationInput?.value.trim();
              const visitTime = timeInput?.value;

              if (name && category && visitTime) {
                places.push({
                  name,
                  category,
                  location: location || null,
                  visit_time: visitTime
                });
              }
            });

            planDetails.push({
              day,
              places
            });
          }

          return {
            planName,
            days,
            planDetails
          };
        };

        // Validate plan
        const validatePlan = () => {
          const planName = nameInput.value.trim();
          if (!planName || planName.length < 3) {
            updateStatus(getTranslation("createPlanPage.validationPlanName") || "Please enter a plan name (at least 3 characters).", "error");
            nameInput.focus();
            return false;
          }

          const days = clampDays(daysInput.value);
          if (days < 1) {
            updateStatus(getTranslation("createPlanPage.validationDays") || "Please enter a valid number of days.", "error");
            daysInput.focus();
            return false;
          }

          // Check if at least one day has at least one place
          let hasPlaces = false;
          for (let day = 1; day <= days; day++) {
            const dayCard = document.querySelector(`[data-day="${day}"]`);
            if (dayCard) {
              const placeRows = dayCard.querySelectorAll(".place-row");
              if (placeRows.length > 0) {
                // Check if at least one place is complete
                placeRows.forEach((row) => {
                  const nameInput = row.querySelector('input[type="text"][name*="-name"]');
                  const categorySelect = row.querySelector('select[name*="-category"]');
                  const timeInput = row.querySelector('input[type="time"]');
                  
                  const name = nameInput?.value.trim();
                  const category = categorySelect?.value;
                  const visitTime = timeInput?.value;
                  
                  if (name && category && visitTime) {
                    hasPlaces = true;
                  }
                });
              }
            }
          }

          if (!hasPlaces) {
            updateStatus(getTranslation("createPlanPage.validationPlaces") || "Please add at least one place to your plan.", "error");
            return false;
          }

          return true;
        };

        // Save plan to database
        const savePlan = async () => {
          console.log("Save plan button clicked");
          
          if (!validatePlan()) {
            console.log("Validation failed");
            return;
          }

          const token = getToken();
          if (!token) {
            updateStatus(getTranslation("createPlanPage.loginRequired") || "Please log in to save your plan.", "error");
            setTimeout(() => {
              window.location.href = "../../auth/login.html";
            }, 2000);
            return;
          }

          const planData = collectPlanData();
          console.log("Collected plan data:", planData);

          // Validate that we have plan details
          if (!planData.planDetails || planData.planDetails.length === 0) {
            updateStatus(getTranslation("createPlanPage.validationNoPlaces") || "No plan details to save. Please add places to your plan.", "error");
            return;
          }

          // Check if at least one day has places
          const hasPlaces = planData.planDetails.some(day => day.places && day.places.length > 0);
          if (!hasPlaces) {
            updateStatus(getTranslation("createPlanPage.validationPlaces") || "Please add at least one place to your plan before saving.", "error");
            return;
          }

          // Disable save button
          savePlanBtn.disabled = true;
          const savingText = getTranslation("createPlanPage.saving") || "Saving...";
          savePlanBtn.textContent = savingText;
          updateStatus(savingText, "muted");

          try {
            const apiUrl = getApiUrl();
            console.log("API URL:", apiUrl);
            
            const requestBody = {
              title: planData.planName,
              plan_details: planData.planDetails
            };
            
            console.log("Request body:", JSON.stringify(requestBody, null, 2));

            const response = await fetch(`${apiUrl}/itineraries`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
              },
              body: JSON.stringify(requestBody)
            });

            console.log("Response status:", response.status);
            
            const data = await response.json();
            console.log("Response data:", data);

            if (!response.ok) {
              throw new Error(data.message || `Failed to save plan (${response.status})`);
            }

            const successMsg = getTranslation("createPlanPage.saveSuccess") || `✅ Plan "${planData.planName}" saved successfully!`;
            updateStatus(successMsg.replace("{name}", planData.planName), "success");
            
            // Reset form after successful save
            setTimeout(() => {
              form.reset();
              nameInput.value = "";
              daysInput.value = 7;
              handleDaysChange();
            }, 2000);

          } catch (error) {
            console.error("Error saving plan:", error);
            const errorMsg = getTranslation("createPlanPage.saveError") || `❌ Error: {error}`;
            updateStatus(errorMsg.replace("{error}", error.message), "error");
          } finally {
            savePlanBtn.disabled = false;
            const saveBtnText = getTranslation("createPlanPage.savePlanBtn") || "Save Plan";
            savePlanBtn.textContent = saveBtnText;
          }
        };

        // Event listeners
        form.addEventListener("submit", (event) => {
          event.preventDefault();
          if (!form.reportValidity()) return;
        });

        form.addEventListener("reset", () => {
          setTimeout(() => {
            nameInput.value = "";
            daysInput.value = 7;
            handleDaysChange();
            updateStatus(getTranslation("createPlanPage.statusReset") || "Form reset.");
          }, 0);
        });

        daysInput.addEventListener("input", handleDaysChange);

        // Attach save button event listener
        if (savePlanBtn) {
          savePlanBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            savePlan();
          });
          console.log("Save plan button event listener attached");
        } else {
          console.error("Save plan button not found!");
        }

        // Initial render
        handleDaysChange();

        // Initialize i18n translations
        const initI18n = () => {
          if (window.i18n && typeof window.i18n.refresh === 'function') {
            window.i18n.refresh();
          } else {
            // Wait for i18n to load
            const checkI18n = setInterval(() => {
              if (window.i18n && typeof window.i18n.refresh === 'function') {
                window.i18n.refresh();
                clearInterval(checkI18n);
              }
            }, 100);
            setTimeout(() => clearInterval(checkI18n), 5000);
          }
        };

        // Setup i18n when ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initI18n);
        } else {
          initI18n();
        }

        // Refresh translations when language changes
        if (window.i18n && typeof window.i18n.subscribe === 'function') {
          window.i18n.subscribe(() => {
            window.i18n.refresh();
          });
        }
      };

      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCreatePlan);
      } else {
        initCreatePlan();
      }
    </script>
  </body>
</html>
