<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© â€¢ Ø§ÙƒØªØ´Ù Ø§Ù„Ù…Ù…Ù„ÙƒØ©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;800;900&family=Tajawal:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../styles/main.css" />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
      body {
        font-family: "Tajawal", sans-serif;
        margin: 0;
        padding: 0;
        background: #faf8f3;
        direction: rtl;
      }

      .header {
        background: rgba(0, 98, 51, 0.95);
        color: white;
        padding: 1rem;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 98, 51, 0.3);
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .header h1 {
        margin: 0;
        font-family: "Cairo", sans-serif;
        font-size: 1.8rem;
      }

      .header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.9;
      }

      .map-container {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 0;
        height: calc(100vh - 80px);
      }

      .controls-panel {
        background: white;
        padding: 20px;
        box-shadow: 2px 0 10px rgba(0, 98, 51, 0.1);
        border-left: 1px solid #e8f5e8;
        overflow-y: auto;
        height: 100%;
      }

      .controls-panel h2 {
        color: #006233;
        font-family: "Cairo", sans-serif;
        font-weight: 700;
        margin: 0 0 16px 0;
        text-align: center;
        font-size: 1.2rem;
      }

      .search-section {
        margin-bottom: 20px;
      }

      .search-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e8f5e8;
        border-radius: 12px;
        font-family: "Tajawal", sans-serif;
        font-size: 1rem;
        margin-bottom: 10px;
        direction: rtl;
        box-sizing: border-box;
      }

      .search-input:focus {
        outline: none;
        border-color: #006233;
      }

      .search-btn {
        width: 100%;
        padding: 12px;
        background: #006233;
        color: white;
        border: none;
        border-radius: 12px;
        font-family: "Tajawal", sans-serif;
        font-size: 1rem;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .search-btn:hover {
        background: #004d26;
      }

      .filter-section {
        margin-bottom: 20px;
      }

      .filter-label {
        display: block;
        font-weight: 600;
        color: #004d26;
        margin-bottom: 8px;
        font-size: 0.9rem;
      }

      .filter-select {
        width: 100%;
        padding: 10px;
        border: 2px solid #e8f5e8;
        border-radius: 8px;
        font-family: "Tajawal", sans-serif;
        direction: rtl;
        box-sizing: border-box;
      }

      .category-filters {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 0.9rem;
      }

      .checkbox-label input[type="checkbox"] {
        margin: 0;
      }

      .map-wrapper {
        position: relative;
        background: white;
      }

      #saudiMap {
        width: 100%;
        height: 100%;
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        font-family: "Tajawal", sans-serif;
        color: #006233;
        font-size: 1.1rem;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e8f5e8;
        border-top: 4px solid #006233;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .stats {
        background: #e8f5e8;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        text-align: center;
        font-size: 0.9rem;
      }

      .action-btn {
        width: 100%;
        padding: 10px;
        background: #006233;
        color: white;
        border: none;
        border-radius: 8px;
        font-family: "Tajawal", sans-serif;
        font-size: 0.9rem;
        cursor: pointer;
        margin-bottom: 8px;
        transition: background 0.3s ease;
      }

      .action-btn:hover {
        background: #004d26;
      }

      .action-btn.secondary {
        background: #6c757d;
      }

      .action-btn.secondary:hover {
        background: #545b62;
      }

      /* Custom Leaflet popup styles */
      .leaflet-popup-content-wrapper {
        border-radius: 12px;
        font-family: "Tajawal", sans-serif;
        direction: rtl;
        text-align: right;
      }

      .leaflet-popup-content {
        margin: 12px 16px;
        line-height: 1.4;
      }

      .place-popup h3 {
        color: #006233;
        margin: 0 0 8px 0;
        font-family: "Cairo", sans-serif;
        font-size: 1.1rem;
      }

      .place-popup p {
        margin: 4px 0;
        font-size: 0.9rem;
      }

      .place-popup .category-badge {
        background: #006233;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        display: inline-block;
        margin-top: 8px;
      }

      /* Custom marker icons */
      .custom-marker-icon {
        background: #006233;
        border: 2px solid white;
        border-radius: 50%;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: bold;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }

      .custom-marker-icon.mosque {
        background: #006233;
      }

      .custom-marker-icon.restaurant {
        background: #dc3545;
      }

      .custom-marker-icon.hotel {
        background: #007bff;
      }

      .custom-marker-icon.tourism {
        background: #28a745;
      }

      .custom-marker-icon.museum {
        background: #6f42c1;
      }

      /* Legend */
      .map-legend {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        font-family: "Tajawal", sans-serif;
        font-size: 0.8rem;
      }

      .map-legend h4 {
        margin: 0 0 8px 0;
        color: #006233;
        font-family: "Cairo", sans-serif;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
      }

      .legend-icon {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: white;
      }

      @media (max-width: 768px) {
        .map-container {
          grid-template-columns: 1fr;
          height: auto;
        }

        .controls-panel {
          height: auto;
          border-left: none;
          border-bottom: 1px solid #e8f5e8;
        }

        .map-wrapper {
          height: 60vh;
        }

        .map-legend {
          bottom: 10px;
          right: 10px;
          font-size: 0.7rem;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <h1>ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</h1>
      <p>
        Ø§ÙƒØªØ´Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ù… Ø§Ù„Ø³ÙŠØ§Ø­ÙŠØ© ÙˆØ§Ù„ØªØ±Ø§Ø«ÙŠØ© ÙˆØ§Ù„Ø«Ù‚Ø§ÙÙŠØ© ÙÙŠ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©
      </p>
    </header>

    <div class="map-container">
      <!-- Controls Panel -->
      <div class="controls-panel">
        <h2>ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©</h2>

        <!-- Search Section -->
        <div class="search-section">
          <input
            type="text"
            id="searchInput"
            class="search-input"
            placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù† Ø£Ùˆ Ù…Ø¹Ù„Ù…..."
          />
          <button id="searchBtn" class="search-btn">ğŸ” Ø§Ù„Ø¨Ø­Ø«</button>
        </div>

        <!-- Region Filter -->
        <div class="filter-section">
          <label for="regionFilter" class="filter-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</label>
          <select id="regionFilter" class="filter-select">
            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
            <option value="riyadh">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙŠØ§Ø¶</option>
            <option value="makkah">Ù…Ù†Ø·Ù‚Ø© Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©</option>
            <option value="madinah">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©</option>
            <option value="eastern">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option>
            <option value="qassim">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù‚ØµÙŠÙ…</option>
            <option value="hail">Ù…Ù†Ø·Ù‚Ø© Ø­Ø§Ø¦Ù„</option>
            <option value="tabuk">Ù…Ù†Ø·Ù‚Ø© ØªØ¨ÙˆÙƒ</option>
            <option value="northern">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©</option>
            <option value="jazan">Ù…Ù†Ø·Ù‚Ø© Ø¬Ø§Ø²Ø§Ù†</option>
            <option value="najran">Ù…Ù†Ø·Ù‚Ø© Ù†Ø¬Ø±Ø§Ù†</option>
            <option value="baha">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¨Ø§Ø­Ø©</option>
            <option value="jouf">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬ÙˆÙ</option>
          </select>
        </div>

        <!-- Category Filter -->
        <div class="filter-section">
          <label class="filter-label">ÙØ¦Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ù…:</label>
          <div class="category-filters">
            <label class="checkbox-label">
              <input
                type="checkbox"
                id="mosques"
                value="religion.place_of_worship"
                checked
              />
              ğŸ•Œ Ø§Ù„Ù…Ø³Ø§Ø¬Ø¯ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ù… Ø§Ù„Ø¯ÙŠÙ†ÙŠØ©
            </label>
            <label class="checkbox-label">
              <input
                type="checkbox"
                id="restaurants"
                value="commercial.restaurant"
                checked
              />
              ğŸ½ï¸ Ø§Ù„Ù…Ø·Ø§Ø¹Ù… ÙˆØ§Ù„Ù…Ù‚Ø§Ù‡ÙŠ
            </label>
            <label class="checkbox-label">
              <input
                type="checkbox"
                id="hotels"
                value="accommodation.hotel"
                checked
              />
              ğŸ¨ Ø§Ù„ÙÙ†Ø§Ø¯Ù‚ ÙˆØ§Ù„Ø¥Ù‚Ø§Ù…Ø©
            </label>
            <label class="checkbox-label">
              <input
                type="checkbox"
                id="tourism"
                value="tourism.sights"
                checked
              />
              ğŸ›ï¸ Ø§Ù„Ù…Ø¹Ø§Ù„Ù… Ø§Ù„Ø³ÙŠØ§Ø­ÙŠØ©
            </label>
            <label class="checkbox-label">
              <input
                type="checkbox"
                id="museums"
                value="tourism.museum"
                checked
              />
              ğŸ›ï¸ Ø§Ù„Ù…ØªØ§Ø­Ù ÙˆØ§Ù„Ù…Ø¹Ø§Ø±Ø¶
            </label>
          </div>
        </div>

        <!-- Actions -->
        <div class="filter-section">
          <button id="loadPlaces" class="action-btn">ğŸ“ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù„Ù…</button>
          <button id="loadBoundaries" class="action-btn">
            ğŸ—ºï¸ Ø¹Ø±Ø¶ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
          </button>
          <button id="centerMap" class="action-btn">
            ğŸ¯ Ù…Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©
          </button>
          <button id="testApi" class="action-btn" style="background: #28a745">
            ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± API
          </button>
          <button id="resetFilters" class="action-btn secondary">
            ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
          </button>
        </div>

        <!-- Stats -->
        <div id="stats" class="stats" style="display: none">
          <div id="statsText">0 Ù…Ø¹Ù„Ù…</div>
        </div>
      </div>

      <!-- Map Area -->
      <div class="map-wrapper">
        <div id="loading" class="loading-overlay" style="display: flex">
          <div>
            <div class="loading-spinner"></div>
            <p>ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©...</p>
          </div>
        </div>
        <div id="saudiMap"></div>

        <!-- Legend -->
        <div class="map-legend">
          <h4>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø±Ù…ÙˆØ²</h4>
          <div class="legend-item">
            <div class="legend-icon mosque">ğŸ•Œ</div>
            <span>Ø§Ù„Ù…Ø³Ø§Ø¬Ø¯</span>
          </div>
          <div class="legend-item">
            <div class="legend-icon restaurant">ğŸ½ï¸</div>
            <span>Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</span>
          </div>
          <div class="legend-item">
            <div class="legend-icon hotel">ğŸ¨</div>
            <span>Ø§Ù„ÙÙ†Ø§Ø¯Ù‚</span>
          </div>
          <div class="legend-item">
            <div class="legend-icon tourism">ğŸ›ï¸</div>
            <span>Ø§Ù„Ù…Ø¹Ø§Ù„Ù… Ø§Ù„Ø³ÙŠØ§Ø­ÙŠØ©</span>
          </div>
          <div class="legend-item">
            <div class="legend-icon museum">ğŸ›ï¸</div>
            <span>Ø§Ù„Ù…ØªØ§Ø­Ù</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      // Saudi Tourism Interactive Map Controller
      class SaudiInteractiveMap {
        constructor() {
          this.apiBaseUrl = "../api.php"; // Use our secure PHP proxy
          this.map = null;
          this.markers = [];
          this.boundaries = [];
          this.currentPlaces = [];
          this.currentRegion = "all";
          this.selectedCategories = new Set([
            "religion.place_of_worship",
            "commercial.restaurant",
            "accommodation.hotel",
            "tourism.sights",
            "tourism.museum",
          ]);

          // Saudi Arabia regions with coordinates
          this.regions = {
            riyadh: { west: 43.0, east: 48.0, south: 22.0, north: 27.0 },
            makkah: { west: 38.0, east: 42.0, south: 20.0, north: 25.0 },
            madinah: { west: 36.0, east: 42.0, south: 22.0, north: 28.0 },
            eastern: { west: 46.0, east: 55.0, south: 16.0, north: 28.0 },
            qassim: { west: 42.0, east: 46.0, south: 25.0, north: 27.0 },
            hail: { west: 40.0, east: 43.0, south: 26.0, north: 29.0 },
            tabuk: { west: 34.0, east: 40.0, south: 26.0, north: 32.0 },
            northern: { west: 38.0, east: 44.0, south: 28.0, north: 32.0 },
            jazan: { west: 41.0, east: 44.0, south: 16.0, north: 19.0 },
            najran: { west: 43.0, east: 47.0, south: 17.0, north: 20.0 },
            baha: { west: 41.0, east: 42.5, south: 19.0, north: 20.5 },
            jouf: { west: 38.0, east: 42.0, south: 29.0, north: 32.0 },
          };

          this.init();
        }

        async init() {
          this.setupEventListeners();
          await this.initializeMap();
          this.hideLoading();
        }

        async initializeMap() {
          // Initialize Leaflet map centered on Saudi Arabia
          this.map = L.map("saudiMap", {
            center: [23.8859, 45.0792],
            zoom: 6,
            maxBounds: [
              [32.5, 34.0],
              [16.0, 56.0],
            ], // Restrict to Saudi Arabia area
            maxBoundsViscosity: 1.0, // Prevent panning outside bounds
          });

          // Add OpenStreetMap tiles
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "Â© OpenStreetMap contributors",
            maxZoom: 18,
            bounds: [
              [32.5, 34.0],
              [16.0, 56.0],
            ], // Restrict tiles to Saudi Arabia
          }).addTo(this.map);

          // Add Saudi Arabia boundary and blur overlay
          await this.addSaudiBoundary();
          this.addSaudiFocus();

          // Load initial places
          await this.loadPlaces();
        }

        async addSaudiBoundary() {
          try {
            // Create Saudi Arabia boundary with proper coordinates
            const saudiBounds = [
              [32.2, 34.5], // [north, west]
              [16.3, 55.7], // [south, east]
            ];

            const saudiBoundary = L.rectangle(saudiBounds, {
              color: "#006233",
              weight: 3,
              fillColor: "#006233",
              fillOpacity: 0.1,
              dashArray: "5, 5",
            }).addTo(this.map);

            // Add popup to boundary
            saudiBoundary.bindPopup(`
                        <div class="place-popup">
                            <h3>ğŸ‡¸ğŸ‡¦ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</h3>
                            <p><strong>Ø§Ù„Ø¹Ø§ØµÙ…Ø©:</strong> Ø§Ù„Ø±ÙŠØ§Ø¶</p>
                            <p><strong>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</strong> 2,149,690 ÙƒÙ…Â²</p>
                            <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù†:</strong> 34.8 Ù…Ù„ÙŠÙˆÙ†</p>
                            <p><strong>Ø§Ù„Ù…Ù†Ø§Ø·Ù‚:</strong> 13 Ù…Ù†Ø·Ù‚Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©</p>
                            <p><strong>API:</strong> Ù…ØªØµÙ„ Ø¹Ø¨Ø± Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø¢Ù…Ù†</p>
                        </div>
                    `);
          } catch (error) {
            console.error("Error loading Saudi boundary:", error);
          }
        }

        addSaudiFocus() {
          // Create overlay to blur areas outside Saudi Arabia
          const worldBounds = [
            [85, -180],
            [-85, 180],
          ];
          const saudiBounds = [
            [32.2, 34.5],
            [16.3, 55.7],
          ];

          // Create a large rectangle covering the world
          const worldOverlay = L.rectangle(worldBounds, {
            color: "rgba(0,0,0,0.3)",
            fillColor: "rgba(0,0,0,0.3)",
            fillOpacity: 0.7,
            weight: 0,
          }).addTo(this.map);

          // Create a hole in the overlay for Saudi Arabia
          const saudiHole = L.rectangle(saudiBounds, {
            color: "transparent",
            fillColor: "transparent",
            fillOpacity: 0,
            weight: 0,
          });

          // Add the hole to the overlay
          worldOverlay.addLayer(saudiHole);
        }

        setupEventListeners() {
          // Search functionality
          document.getElementById("searchBtn").addEventListener("click", () => {
            this.searchPlaces();
          });

          document
            .getElementById("searchInput")
            .addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                this.searchPlaces();
              }
            });

          // Region filter
          document
            .getElementById("regionFilter")
            .addEventListener("change", (e) => {
              this.currentRegion = e.target.value;
            });

          // Category filters
          document
            .querySelectorAll('.category-filters input[type="checkbox"]')
            .forEach((checkbox) => {
              checkbox.addEventListener("change", () => {
                this.updateSelectedCategories();
              });
            });

          // Action buttons
          document
            .getElementById("loadPlaces")
            .addEventListener("click", () => {
              this.loadPlaces();
            });

          document
            .getElementById("loadBoundaries")
            .addEventListener("click", () => {
              this.loadRegionBoundaries();
            });

          document.getElementById("centerMap").addEventListener("click", () => {
            this.centerOnSaudi();
          });

          document.getElementById("testApi").addEventListener("click", () => {
            this.testApiConnection();
          });

          document
            .getElementById("resetFilters")
            .addEventListener("click", () => {
              this.resetFilters();
            });
        }

        updateSelectedCategories() {
          this.selectedCategories.clear();
          document
            .querySelectorAll(
              '.category-filters input[type="checkbox"]:checked'
            )
            .forEach((checkbox) => {
              this.selectedCategories.add(checkbox.value);
            });
        }

        async searchPlaces() {
          const searchTerm = document
            .getElementById("searchInput")
            .value.trim();
          if (!searchTerm) {
            alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ØµØ·Ù„Ø­ Ø§Ù„Ø¨Ø­Ø«");
            return;
          }

          this.showLoading();

          try {
            // Use our secure PHP proxy for geocoding
            const searchUrl = `${
              this.apiBaseUrl
            }/geocode?text=${encodeURIComponent(
              searchTerm
            )}&countrycode=sa&limit=50`;

            console.log("Searching with URL:", searchUrl);

            const response = await fetch(searchUrl);
            const data = await response.json();

            console.log("Search response:", data);

            if (data.features && data.features.length > 0) {
              // Filter results to ensure they are actually in Saudi Arabia
              const saudiResults = data.features.filter((feature) => {
                const country =
                  feature.properties.country_code || feature.properties.country;
                const coords = feature.geometry.coordinates;
                const lat = coords[1];
                const lng = coords[0];

                // Check if coordinates are within Saudi Arabia bounds
                const inSaudiBounds =
                  lat >= 16.3 && lat <= 32.2 && lng >= 34.5 && lng <= 55.7;

                return (
                  country === "SA" ||
                  country === "Saudi Arabia" ||
                  inSaudiBounds
                );
              });

              if (saudiResults.length > 0) {
                this.clearMarkers();
                this.addSearchResults(saudiResults);
                this.centerOnSearchResults(saudiResults);
                alert(
                  `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${saudiResults.length} Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ù„Ù€: ${searchTerm}`
                );
              } else {
                alert(
                  `Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ù„Ù€: ${searchTerm}. Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨ÙƒÙ„Ù…Ø§Øª Ù…Ø®ØªÙ„ÙØ©.`
                );
              }
            } else {
              alert(
                `Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ù„Ù€: ${searchTerm}. Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨ÙƒÙ„Ù…Ø§Øª Ù…Ø®ØªÙ„ÙØ©.`
              );
            }
          } catch (error) {
            console.error("Search error:", error);
            alert(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${error.message}`);
          } finally {
            this.hideLoading();
          }
        }

        async loadPlaces() {
          this.showLoading();

          try {
            const categories = Array.from(this.selectedCategories).join(",");
            const bounds =
              this.currentRegion === "all"
                ? { west: 34.5, east: 55.7, south: 16.3, north: 32.2 }
                : this.regions[this.currentRegion];

            // Load multiple batches to get more results
            let allPlaces = [];
            let offset = 0;
            const limit = 100; // Maximum per request
            const maxRequests = 5; // Limit to prevent too many API calls

            for (let i = 0; i < maxRequests; i++) {
              // Use our secure PHP proxy for places
              const rectParam = `${bounds.west},${bounds.south},${bounds.east},${bounds.north}`;
              const placesUrl = `${this.apiBaseUrl}/places?categories=${categories}&rect=${rectParam}&limit=${limit}&offset=${offset}`;

              console.log(`Loading batch ${i + 1} from URL:`, placesUrl);

              const response = await fetch(placesUrl);
              const data = await response.json();

              console.log(`Batch ${i + 1} response:`, data);

              if (data.features && data.features.length > 0) {
                allPlaces = allPlaces.concat(data.features);

                // If we got less than the limit, we've reached the end
                if (data.features.length < limit) {
                  break;
                }

                offset += limit;
              } else {
                break;
              }
            }

            console.log(`Total places loaded: ${allPlaces.length}`);

            if (allPlaces.length > 0) {
              // Filter results to ensure they are actually in Saudi Arabia
              const saudiPlaces = allPlaces.filter((feature) => {
                const coords = feature.geometry.coordinates;
                const lat = coords[1];
                const lng = coords[0];

                // Check if coordinates are within Saudi Arabia bounds
                const inSaudiBounds =
                  lat >= 16.3 && lat <= 32.2 && lng >= 34.5 && lng <= 55.7;

                // Additional check for region if not "all"
                if (this.currentRegion !== "all") {
                  const region = this.regions[this.currentRegion];
                  const inRegionBounds =
                    lat >= region.south &&
                    lat <= region.north &&
                    lng >= region.west &&
                    lng <= region.east;
                  return inSaudiBounds && inRegionBounds;
                }

                return inSaudiBounds;
              });

              if (saudiPlaces.length > 0) {
                this.clearMarkers();
                this.addPlacesToMap(saudiPlaces);
                this.currentPlaces = saudiPlaces;
                this.updateStats();

                // Center on region if specific region selected
                if (this.currentRegion !== "all") {
                  this.centerOnRegion(this.currentRegion);
                }

                alert(
                  `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${saudiPlaces.length} Ù…Ø¹Ù„Ù… ÙÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­! (Ù…Ù† ${allPlaces.length} Ù†ØªÙŠØ¬Ø© Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©)`
                );
              } else {
                alert(
                  "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø§Ù„Ù… ÙÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©. Ø¬Ø±Ø¨ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø£Ùˆ Ø§Ù„ÙØ¦Ø©."
                );
              }
            } else {
              alert(
                "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø§Ù„Ù… ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©. Ø¬Ø±Ø¨ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø£Ùˆ Ø§Ù„ÙØ¦Ø©."
              );
            }
          } catch (error) {
            console.error("Error loading places:", error);
            alert(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù„Ù…: ${error.message}`);
          } finally {
            this.hideLoading();
          }
        }

        async loadRegionBoundaries() {
          this.showLoading();

          try {
            // Clear existing boundaries
            this.boundaries.forEach((boundary) =>
              this.map.removeLayer(boundary)
            );
            this.boundaries = [];

            // Load boundaries for each region
            const regionPromises = Object.keys(this.regions).map(
              async (regionKey) => {
                try {
                  const region = this.regions[regionKey];
                  const searchUrl = `${
                    this.apiBaseUrl
                  }/geocode?text=${encodeURIComponent(
                    this.getRegionName(regionKey)
                  )}&countrycode=sa&limit=1`;

                  const response = await fetch(searchUrl);
                  const data = await response.json();

                  if (data.features && data.features.length > 0) {
                    const feature = data.features[0];
                    const coordinates = feature.geometry.coordinates;

                    // Create boundary rectangle for the region
                    const bounds = [
                      [region.north, region.west],
                      [region.south, region.east],
                    ];

                    const boundary = L.rectangle(bounds, {
                      color: "#006233",
                      weight: 2,
                      fillColor: "#006233",
                      fillOpacity: 0.1,
                    }).addTo(this.map);

                    // Add popup
                    boundary.bindPopup(`
                                    <div class="place-popup">
                                        <h3>${this.getRegionName(
                                          regionKey
                                        )}</h3>
                                        <p>Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: ${coordinates[1].toFixed(
                                          6
                                        )}, ${coordinates[0].toFixed(6)}</p>
                                    </div>
                                `);

                    this.boundaries.push(boundary);
                  }
                } catch (error) {
                  console.warn(
                    `Error loading boundary for ${regionKey}:`,
                    error
                  );
                }
              }
            );

            await Promise.all(regionPromises);
          } catch (error) {
            alert(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚: ${error.message}`);
          } finally {
            this.hideLoading();
          }
        }

        addPlacesToMap(places) {
          places.forEach((place) => {
            this.addPlaceMarker(place);
          });
        }

        addSearchResults(places) {
          places.forEach((place) => {
            this.addPlaceMarker(place, true);
          });
        }

        addPlaceMarker(place, isSearchResult = false) {
          const coordinates = place.geometry.coordinates;
          const lat = coordinates[1];
          const lng = coordinates[0];

          // Determine marker type and icon
          const category = place.properties.categories?.[0] || "";
          const markerType = this.getMarkerType(category);
          const icon = this.getMarkerIcon(category);

          // Create custom marker icon
          const customIcon = L.divIcon({
            className: "custom-marker-icon",
            html: `<div class="custom-marker-icon ${markerType}">${icon}</div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15],
            popupAnchor: [0, -15],
          });

          // Create marker
          const marker = L.marker([lat, lng], { icon: customIcon }).addTo(
            this.map
          );

          // Create popup content
          const popupContent = this.createPopupContent(place);
          marker.bindPopup(popupContent);

          this.markers.push(marker);
        }

        getMarkerType(category) {
          if (category.includes("religion")) return "mosque";
          if (category.includes("restaurant")) return "restaurant";
          if (category.includes("hotel")) return "hotel";
          if (category.includes("tourism")) return "tourism";
          if (category.includes("museum")) return "museum";
          return "tourism";
        }

        getMarkerIcon(category) {
          if (category.includes("religion")) return "ğŸ•Œ";
          if (category.includes("restaurant")) return "ğŸ½ï¸";
          if (category.includes("hotel")) return "ğŸ¨";
          if (category.includes("tourism")) return "ğŸ›ï¸";
          if (category.includes("museum")) return "ğŸ›ï¸";
          return "ğŸ“";
        }

        createPopupContent(place) {
          const name = place.properties.name || "Ù…ÙƒØ§Ù† ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
          const address =
            place.properties.formatted || place.properties.address_line2 || "";
          const phone = place.properties.phone || "";
          const website = place.properties.website || "";
          const category = this.getCategoryName(
            place.properties.categories?.[0]
          );
          const coordinates = place.geometry.coordinates;

          return `
                    <div class="place-popup">
                        <h3>${name}</h3>
                        <p><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${category}</p>
                        ${
                          address
                            ? `<p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${address}</p>`
                            : ""
                        }
                        ${
                          phone
                            ? `<p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${phone}</p>`
                            : ""
                        }
                        ${
                          website
                            ? `<p><strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> <a href="${website}" target="_blank">Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</a></p>`
                            : ""
                        }
                        <p><strong>Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</strong> ${coordinates[1].toFixed(
                          6
                        )}, ${coordinates[0].toFixed(6)}</p>
                        <div class="category-badge">${category}</div>
                    </div>
                `;
        }

        getCategoryName(category) {
          const categoryNames = {
            "religion.place_of_worship": "Ù…Ø¹Ù„Ù… Ø¯ÙŠÙ†ÙŠ",
            "commercial.restaurant": "Ù…Ø·Ø¹Ù…",
            "accommodation.hotel": "ÙÙ†Ø¯Ù‚",
            "tourism.sights": "Ù…Ø¹Ù„Ù… Ø³ÙŠØ§Ø­ÙŠ",
            "tourism.museum": "Ù…ØªØ­Ù",
          };
          return categoryNames[category] || "Ù…Ø¹Ù„Ù…";
        }

        getRegionName(regionKey) {
          const regionNames = {
            riyadh: "Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙŠØ§Ø¶",
            makkah: "Ù…Ù†Ø·Ù‚Ø© Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©",
            madinah: "Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©",
            eastern: "Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©",
            qassim: "Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù‚ØµÙŠÙ…",
            hail: "Ù…Ù†Ø·Ù‚Ø© Ø­Ø§Ø¦Ù„",
            tabuk: "Ù…Ù†Ø·Ù‚Ø© ØªØ¨ÙˆÙƒ",
            northern: "Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©",
            jazan: "Ù…Ù†Ø·Ù‚Ø© Ø¬Ø§Ø²Ø§Ù†",
            najran: "Ù…Ù†Ø·Ù‚Ø© Ù†Ø¬Ø±Ø§Ù†",
            baha: "Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¨Ø§Ø­Ø©",
            jouf: "Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬ÙˆÙ",
          };
          return regionNames[regionKey] || "Ù…Ù†Ø·Ù‚Ø©";
        }

        centerOnSaudi() {
          this.map.setView([23.8859, 45.0792], 6);
          // Clear any existing markers and boundaries
          this.clearMarkers();
          this.boundaries.forEach((boundary) => this.map.removeLayer(boundary));
          this.boundaries = [];
          // Reload Saudi boundary
          this.addSaudiBoundary();
        }

        centerOnRegion(regionKey) {
          const region = this.regions[regionKey];
          if (region) {
            const bounds = [
              [region.north, region.west],
              [region.south, region.east],
            ];
            this.map.fitBounds(bounds);
          }
        }

        centerOnSearchResults(places) {
          if (places.length === 1) {
            const coords = places[0].geometry.coordinates;
            this.map.setView([coords[1], coords[0]], 12);
          } else if (places.length > 1) {
            const group = new L.featureGroup();
            places.forEach((place) => {
              const coords = place.geometry.coordinates;
              group.addLayer(L.marker([coords[1], coords[0]]));
            });
            this.map.fitBounds(group.getBounds().pad(0.1));
          }
        }

        clearMarkers() {
          this.markers.forEach((marker) => this.map.removeLayer(marker));
          this.markers = [];
        }

        updateStats() {
          const statsDiv = document.getElementById("stats");
          const statsText = document.getElementById("statsText");

          statsText.textContent = `${this.currentPlaces.length} Ù…Ø¹Ù„Ù…`;
          statsDiv.style.display = "block";
        }

        resetFilters() {
          // Reset search
          document.getElementById("searchInput").value = "";

          // Reset region
          document.getElementById("regionFilter").value = "all";
          this.currentRegion = "all";

          // Reset categories
          document
            .querySelectorAll('.category-filters input[type="checkbox"]')
            .forEach((checkbox) => {
              checkbox.checked = true;
            });
          this.updateSelectedCategories();

          // Clear markers and boundaries
          this.clearMarkers();
          this.boundaries.forEach((boundary) => this.map.removeLayer(boundary));
          this.boundaries = [];

          // Reset stats
          document.getElementById("stats").style.display = "none";

          // Center on Saudi Arabia
          this.centerOnSaudi();
        }

        showLoading() {
          document.getElementById("loading").style.display = "flex";
        }

        hideLoading() {
          document.getElementById("loading").style.display = "none";
        }

        async testApiConnection() {
          this.showLoading();

          try {
            // Test both Geocoding and Places APIs through our PHP proxy
            const geocodeUrl = `${this.apiBaseUrl}/geocode?text=Riyadh&countrycode=sa&limit=5`;
            const placesUrl = `${this.apiBaseUrl}/places?categories=religion.place_of_worship&rect=34.5,16.3,55.7,32.2&limit=5`;

            console.log("Testing Geocoding API:", geocodeUrl);
            console.log("Testing Places API:", placesUrl);

            // Test Geocoding API
            const geocodeResponse = await fetch(geocodeUrl);
            const geocodeData = await geocodeResponse.json();

            // Test Places API
            const placesResponse = await fetch(placesUrl);
            const placesData = await placesResponse.json();

            console.log("Geocoding API Response:", geocodeData);
            console.log("Places API Response:", placesData);

            let results = [];

            if (geocodeData.features && geocodeData.features.length > 0) {
              results = results.concat(geocodeData.features);
            }

            if (placesData.features && placesData.features.length > 0) {
              results = results.concat(placesData.features);
            }

            if (results.length > 0) {
              // Filter to Saudi Arabia only
              const saudiResults = results.filter((feature) => {
                const coords = feature.geometry.coordinates;
                const lat = coords[1];
                const lng = coords[0];
                const inSaudiBounds =
                  lat >= 16.3 && lat <= 32.2 && lng >= 34.5 && lng <= 55.7;
                return inSaudiBounds;
              });

              if (saudiResults.length > 0) {
                alert(
                  `âœ… API ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­!\n\nğŸ” Geocoding API: ${
                    geocodeData.features?.length || 0
                  } Ù†ØªÙŠØ¬Ø©\nğŸ“ Places API: ${
                    placesData.features?.length || 0
                  } Ù†ØªÙŠØ¬Ø©\nğŸ‡¸ğŸ‡¦ ÙÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©: ${
                    saudiResults.length
                  } Ù†ØªÙŠØ¬Ø©\n\nÙ…Ø«Ø§Ù„: ${
                    saudiResults[0].properties.formatted ||
                    saudiResults[0].properties.name
                  }`
                );

                // Show the results on map
                this.clearMarkers();
                this.addSearchResults(saudiResults);
                this.centerOnSearchResults(saudiResults);
              } else {
                alert("âŒ API ÙŠØ¹Ù…Ù„ Ù„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©");
              }
            } else {
              alert("âŒ API Ù„Ø§ ÙŠØ¹Ù…Ù„ Ø£Ùˆ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬");
            }
          } catch (error) {
            console.error("API Test Error:", error);
            alert(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ API: ${error.message}`);
          } finally {
            this.hideLoading();
          }
        }
      }

      // Initialize the interactive map when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        new SaudiInteractiveMap();
      });
    </script>
  </body>
</html>
