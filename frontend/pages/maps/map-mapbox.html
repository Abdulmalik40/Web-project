<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <title>Saudi Arabia Map - Mapbox â€¢ Ø§ÙƒØªØ´Ù Ø§Ù„Ù…Ù…Ù„ÙƒØ©</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;800;900&family=Tajawal:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.css"
      rel="stylesheet"
    />
    <!-- Mapbox Geocoder CSS -->
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.css"
      type="text/css"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: "Tajawal", sans-serif;
        direction: rtl;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }

      /* Filter Panel */
      .filter-panel {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        padding: 16px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        font-family: "Tajawal", sans-serif;
        min-width: 220px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .filter-panel h3 {
        margin: 0 0 12px 0;
        color: #006233;
        font-size: 1rem;
        font-weight: 600;
      }

      .filter-group {
        margin-bottom: 12px;
      }

      .filter-group label {
        display: block;
        margin-bottom: 6px;
        font-size: 0.9rem;
        color: #333;
        font-weight: 500;
      }

      .filter-group select {
        width: 100%;
        padding: 8px;
        border: 2px solid #e8f5e8;
        border-radius: 6px;
        font-family: "Tajawal", sans-serif;
        font-size: 0.9rem;
        direction: rtl;
        cursor: pointer;
        box-sizing: border-box;
      }

      .filter-group select:focus {
        outline: none;
        border-color: #006233;
      }

      /* Mapbox Popup Styling */
      .mapboxgl-popup-content {
        font-family: "Tajawal", sans-serif;
        direction: rtl;
        text-align: right;
        padding: 16px;
        min-width: 250px;
        max-width: 400px;
      }

      .mapboxgl-popup-content h3 {
        color: #006233;
        margin: 0 0 8px 0;
        font-size: 1.2rem;
        font-weight: 700;
      }

      .mapboxgl-popup-content img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        margin-top: 8px;
        display: block;
      }

      .mapboxgl-popup-content .popup-info {
        margin: 8px 0;
        font-size: 0.9rem;
        color: #666;
      }

      .mapboxgl-popup-content .popup-info strong {
        color: #006233;
      }

      .popup-rating {
        color: #f7931e;
        font-weight: 600;
      }

      /* Geocoder styling */
      .mapboxgl-ctrl-geocoder {
        width: 100%;
        max-width: 400px;
        font-family: "Tajawal", sans-serif;
        direction: rtl;
      }

      .mapboxgl-ctrl-geocoder input {
        direction: rtl;
        text-align: right;
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        flex-direction: column;
        font-family: "Tajawal", sans-serif;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #e8f5e8;
        border-top: 4px solid #006233;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
      }
      #search-input {
        width: 100%;
        max-width: 100%;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="loading" class="loading-overlay">
      <div class="loading-spinner"></div>
      <p>ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel" style="display: none">
      <h3>ğŸ” Ø§Ù„ÙÙ„ØªØ±Ø©</h3>
      <div class="filter-group">
        <label for="categoryFilter">Ø§Ù„ÙØ¦Ø©:</label>
        <select id="categoryFilter">
          <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="regionFilter">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</label>
        <select id="regionFilter">
          <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
        </select>
      </div>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.js"></script>
    <!-- Mapbox Geocoder JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.min.js"></script>

    <script>
      mapboxgl.accessToken =
        "pk.eyJ1IjoiYWJkdWxtYWxpazQwIiwiYSI6ImNtaHphOHEzdDBlZngyanNmNXFobTJ1eXYifQ.BXgODp-9zJ1ZJ6lxFtA9gw";

      const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/abdulmalik40/cmi7scr63000j01r4gbo330gf/draft",
        center: [46.46, 25.53],
        zoom: 3,
      });

      // 1. Add Navigation Control (Zoom buttons)
      map.addControl(new mapboxgl.NavigationControl(), "top-left");

      // 2. Add Search (Geocoder)
      map.addControl(
        new MapboxGeocoder({
          accessToken: mapboxgl.accessToken,
          mapboxgl: mapboxgl,
          placeholder: "Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù†...",
          language: "ar",
          marker: true,
          proximity: [46.46, 25.53],
        }),
        "top-right"
      );

      // GeoJSON file paths (relative to HTML file)
      const GEOJSON_FILES = [
        "../../../backend/data/Geojson/Final_resturant.csv.geojson",
        "../../../backend/data/Geojson/Full_cafe.csv.geojson",
        "../../../backend/data/Geojson/Full_entr.csv.geojson",
        "../../../backend/data/Geojson/Full_hotel.csv.geojson",
        "../../../backend/data/Geojson/Hospital_full.csv.geojson",
        "../../../backend/data/Geojson/Metro_Final.csv.geojson",
        "../../../backend/data/Geojson/MousqesTabeFull.csv.geojson",
      ];

      let allPlaces = {
        type: "FeatureCollection",
        features: [],
      };

      // Load all GeoJSON files and combine them
      async function loadAllGeoJSONFiles() {
        try {
          const loadPromises = GEOJSON_FILES.map(async (filePath) => {
            try {
              const response = await fetch(filePath);
              if (!response.ok) {
                console.warn(`Failed to load ${filePath}: ${response.status}`);
                return null;
              }
              const data = await response.json();
              return data;
            } catch (error) {
              console.error(`Error loading ${filePath}:`, error);
              return null;
            }
          });

          const loadedFiles = await Promise.all(loadPromises);

          // Combine all features
          loadedFiles.forEach((geojson) => {
            if (geojson && geojson.features) {
              allPlaces.features.push(...geojson.features);
            }
          });

          console.log(`Loaded ${allPlaces.features.length} total places`);

          // Normalize category names (handle variations)
          normalizeCategories();

          return allPlaces;
        } catch (error) {
          console.error("Error loading GeoJSON files:", error);
          throw error;
        }
      }

      // Normalize category names to match filter options
      function normalizeCategories() {
        const categoryMap = {
          Restaurant: "Resturant",
          Resturant: "Resturant",
          Cafe: "Cafe",
          Hotel: "Hotel",
          Hospital: "Hospital",
          Metro: "Metro",
          Mosque: "Mosque",
          Entertainment: "Entertament",
          Entertament: "Entertament",
        };

        allPlaces.features.forEach((feature) => {
          if (feature.properties.category) {
            const normalized =
              categoryMap[feature.properties.category] ||
              feature.properties.category;
            feature.properties.category = normalized;
          }
        });
      }

      // Wait for map to load
      map.on("load", async () => {
        console.log("Map loaded successfully");

        try {
          // Load all GeoJSON files
          await loadAllGeoJSONFiles();

          // Add combined data to map
          addPlacesToMap();

          // Setup interactions
          setupPlaceInteractions();

          // Setup filters
          setupFilters();

          // Hide loading
          document.getElementById("loading").style.display = "none";
          document.querySelector(".filter-panel").style.display = "block";
        } catch (error) {
          console.error("Error initializing map:", error);
          document.getElementById("loading").innerHTML = `
            <div style="text-align: center; color: #e74c3c;">
              <div style="font-size: 3rem; margin-bottom: 16px;">âš ï¸</div>
              <p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
              <button onclick="location.reload()" style="
                background: #006233; 
                color: white; 
                border: none; 
                padding: 12px 24px; 
                border-radius: 8px; 
                cursor: pointer;
                margin-top: 16px;
              ">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
            </div>
          `;
        }
      });

      // Add places to map
      function addPlacesToMap() {
        // Add source
        map.addSource("places", {
          type: "geojson",
          data: allPlaces,
        });

        // Add circle layer for points
        map.addLayer({
          id: "places-circles",
          type: "circle",
          source: "places",
          paint: {
            "circle-radius": [
              "interpolate",
              ["linear"],
              ["zoom"],
              3,
              3,
              6,
              5,
              10,
              8,
              14,
              12,
            ],
            "circle-color": [
              "match",
              ["get", "category"],
              "Cafe",
              "#f7931e",
              "Resturant",
              "#e74c3c",
              "Hotel",
              "#3498db",
              "Hospital",
              "#e91e63",
              "Metro",
              "#9b59b6",
              "Mosque",
              "#006233",
              "Entertament",
              "#1abc9c",
              "#666",
            ],
            "circle-stroke-width": 2,
            "circle-stroke-color": "#fff",
            "circle-opacity": 0.8,
          },
        });

        // Add symbol layer for text labels (names above icons)
        map.addLayer({
          id: "places-labels",
          type: "symbol",
          source: "places",
          layout: {
            "text-field": ["get", "name"],
            "text-anchor": "top",
            "text-offset": [0, 0.8],
            "text-size": [
              "interpolate",
              ["linear"],
              ["zoom"],
              3,
              10,
              6,
              11,
              10,
              12,
              14,
              14,
            ],
            "text-font": ["Open Sans Regular", "Arial Unicode MS Regular"],
            "text-allow-overlap": false,
            "text-ignore-placement": false,
          },
          paint: {
            "text-color": "#006233",
            "text-halo-color": "#ffffff",
            "text-halo-width": 2,
            "text-halo-blur": 1,
          },
        });

        console.log("Places added to map");
      }

      // Setup click interactions
      function setupPlaceInteractions() {
        // Click interaction - show popup with name + photo
        map.on("click", "places-circles", (e) => {
          const feature = e.features[0];
          const coords = feature.geometry.coordinates.slice();
          const p = feature.properties;

          const html = `
            <div>
              <strong>${p.name || ""}</strong><br/>
              ${
                p.rating ? `<div class="popup-rating">â­ ${p.rating}</div>` : ""
              }
              ${
                p.category
                  ? `<div class="popup-info"><strong>Category:</strong> ${p.category}</div>`
                  : ""
              }
              ${
                p.region
                  ? `<div class="popup-info"><strong>Region:</strong> ${p.region}</div>`
                  : ""
              }
              ${
                p.photo || p.image_url
                  ? `<img src="${
                      p.photo || p.image_url
                    }" style="max-width:200px;max-height:150px;margin-top:5px;display:block;border-radius:4px;" />`
                  : ""
              }
              ${
                p.link
                  ? `<div style="margin-top:8px;"><a href="${p.link}" target="_blank" style="color:#006233;text-decoration:none;">ğŸ“ View on Google Maps</a></div>`
                  : ""
              }
            </div>
          `;

          new mapboxgl.Popup().setLngLat(coords).setHTML(html).addTo(map);
        });

        // Optional: pointer cursor when hovering places
        map.on("mouseenter", "places-circles", () => {
          map.getCanvas().style.cursor = "pointer";
        });

        map.on("mouseleave", "places-circles", () => {
          map.getCanvas().style.cursor = "";
        });
      }

      // Setup filters
      function setupFilters() {
        // Get unique categories and regions from data
        const categories = [
          ...new Set(
            allPlaces.features
              .map((f) => f.properties?.category)
              .filter((c) => c)
          ),
        ].sort();

        const regions = [
          ...new Set(
            allPlaces.features.map((f) => f.properties?.region).filter((r) => r)
          ),
        ].sort();

        // Populate category filter
        const categorySelect = document.getElementById("categoryFilter");
        categories.forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat;
          option.textContent = cat;
          categorySelect.appendChild(option);
        });

        // Populate region filter
        const regionSelect = document.getElementById("regionFilter");
        regions.forEach((reg) => {
          const option = document.createElement("option");
          option.value = reg;
          option.textContent = reg;
          regionSelect.appendChild(option);
        });

        // Apply filters on change
        document
          .getElementById("categoryFilter")
          .addEventListener("change", applyFilters);

        document
          .getElementById("regionFilter")
          .addEventListener("change", applyFilters);

        console.log(
          "Filters setup complete. Categories:",
          categories,
          "Regions:",
          regions
        );
      }

      // Apply filter function
      function applyFilters() {
        const cat = document.getElementById("categoryFilter").value;
        const reg = document.getElementById("regionFilter").value;

        const filter = ["all"];

        if (cat !== "all") {
          filter.push(["==", ["get", "category"], cat]);
        }

        if (reg !== "all") {
          filter.push(["==", ["get", "region"], reg]);
        }

        // Apply filter to both layers
        if (filter.length === 1) {
          map.setFilter("places-circles", null);
          map.setFilter("places-labels", null);
        } else {
          map.setFilter("places-circles", filter);
          map.setFilter("places-labels", filter);
        }

        console.log("Filter applied:", filter);
      }

      // Export map for global access
      window.saudiMapboxMap = map;
    </script>
  </body>
</html>
