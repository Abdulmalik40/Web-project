<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ù…Ø§ÙƒÙ† ÙÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

    <!-- MapLibre CSS -->
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.13.0/dist/maplibre-gl.css" />

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #f5f5f5;
        }

        #app {
            display: flex;
            height: 100vh;
            direction: rtl;
        }

        /* Sidebar */
        #sidebar {
            width: 320px;
            max-width: 100%;
            background: #ffffff;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        #sidebar-header {
           display: flex;
           justify-content: space-between;
           align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
        }

        #sidebar-header h2 {
            margin: 0;
            font-size: 18px;
            color: #006233;
        }

        /* Mode toggle */
        #search-mode-toggle {
            display: flex;
            padding: 8px 12px;
            gap: 6px;
            border-bottom: 1px solid #eee;
        }

        #search-mode-toggle button {
            flex: 1;
            padding: 6px;
            font-size: 13px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: #fafafa;
            cursor: pointer;
        }

        #search-mode-toggle button.active {
            background: #006233;
            color: #fff;
            border-color: #006233;
        }

        /* Filters container (local search) */
        #local-filters {
            padding: 8px 12px 12px 12px;
            border-bottom: 1px solid #eee;
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .filter-group label {
            font-size: 13px;
            color: #555;
            display: block;
            margin-bottom: 4px;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 13px;
            direction: rtl;
        }

        #reset-filters {
            width: 100%;
            padding: 6px;
            font-size: 13px;
            border-radius: 4px;
            border: none;
            background: #006233;
            color: white;
            cursor: pointer;
        }

        #reset-filters:hover {
            background: #008c44;
        }

        #places-count {
            padding: 6px 12px;
            font-size: 13px;
            color: #666;
            border-bottom: 1px solid #eee;
        }

        /* Local places list */
        #places-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 8px 12px 8px;
        }

        .place-item {
            background: #fafafa;
            border-radius: 6px;
            border: 1px solid #eee;
            padding: 8px 10px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: background 0.15s, box-shadow 0.15s, transform 0.05s;
        }

        .place-item:hover {
            background: #f0fdf4;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .place-item.active {
            background: #e6f7ff;
            border-color: #1890ff;
        }

        .place-title {
            margin: 0 0 4px 0;
            font-size: 14px;
            font-weight: 600;
            color: #222;
        }

        .place-meta {
            font-size: 12px;
            color: #555;
        }

        .place-meta span {
            display: inline-block;
            margin-left: 6px;
        }

        /* Global (Photon) search container */
        #global-search-container {
            display: none; /* hidden by default; shown when global mode is active */
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        #global-search-container input {
            width: 100%;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-bottom: 6px;
            direction: rtl;
        }

        #global-search-results {
            max-height: 180px;
            overflow-y: auto;
        }

        .global-result-item {
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #eee;
            margin-bottom: 4px;
            background: #fafafa;
            cursor: pointer;
        }

        .global-result-item:hover {
            background: #e8f4ff;
        }

        .global-result-title {
            margin: 0;
            font-size: 13px;
            font-weight: 600;
        }

        .global-result-meta {
            font-size: 11px;
            color: #666;
        }

        /* Map */
        #map {
            flex: 1;
            position: relative;
        }

        .maplibregl-popup-content {
            font-family: "Tajawal", sans-serif;
            direction: rtl;
            text-align: right;
        }

        /* Loading overlay */
        #loading {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 18px;
            color: #006233;
            z-index: 2000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 4px solid #e0f2e9;
            border-top-color: #006233;
            animation: spin 0.9s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .back-button {
            display: inline-block;
            margin-top: 6px;
            font-size: 12px;
            color: #006233;
            text-decoration: none;
            border: 1px solid #006233;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s, color 0.2s;
        }
        @media (max-width: 768px) {
            #app {
                flex-direction: column;
            }
            #sidebar {
                width: 100%;
                height: 45%;
                max-height: 45%;
            }
            #map {
                height: 55%;
            }
        }
    </style>
</head>
<body>

<div id="app">
    <div id="sidebar">
        <div id="sidebar-header">
            <h2>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ù…Ø§ÙƒÙ†</h2>
            <a class="back-button" href="/index.html">Ø§Ù„Ø¹ÙˆØ¯Ø© Ø§Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹</a>
        </div>

        <!-- Mode toggle A/B -->
        <div id="search-mode-toggle">
            <button id="mode-local" class="active">ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù…Ø­Ù„ÙŠØ©</button>
            <button id="mode-global">ğŸŒ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ (Photon)</button>
        </div>

        <!-- Local search & filters -->
        <div id="local-filters">
            <div class="filter-group">
                <label for="search-input">Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… (Ù…Ø­Ù„ÙŠ)</label>
                <input id="search-input" type="text" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø©..." />
            </div>

            <div class="filter-group">
                <label for="category-select">Ø§Ù„ÙØ¦Ø© (Category)</label>
                <select id="category-select">
                    <option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="region-select">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Region)</label>
                <select id="region-select">
                    <option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
                </select>
            </div>

            <button id="reset-filters">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±</button>
        </div>

        <!-- Global Photon search -->
        <div id="global-search-container">
            <label for="global-search-input">Ø¨Ø­Ø« Ø¹Ø§Ù„Ù…ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Photon (Ø£ÙŠ Ù…ÙƒØ§Ù† ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…)</label>
            <input id="global-search-input" type="text" placeholder="Ù…Ø«Ø§Ù„: Mecca, Riyadh, Jeddah..." />
            <div id="global-search-results"></div>
        </div>

        <div id="places-count">0 Ù…ÙƒØ§Ù†</div>

        <div id="places-list"></div>
    </div>

    <div id="map"></div>
</div>

<div id="loading">
    <div class="spinner"></div>
    <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
</div>

<!-- MapLibre JS -->
<script src="https://unpkg.com/maplibre-gl@5.13.0/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/@mapbox/mapbox-gl-rtl-text@0.3.0/dist/mapbox-gl-rtl-text.js"></script>

<script>
    // Ø¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© RTL
    maplibregl.setRTLTextPlugin(
        "https://unpkg.com/@mapbox/mapbox-gl-rtl-text@0.3.0/dist/mapbox-gl-rtl-text.js"
    );

    // Ù…Ù„ÙØ§Øª GeoJSON Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ Geojson Ø¨Ø¬Ø§Ù†Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù
    const GEOJSON_FILES = [
        "Geojson/Bus_cleaned.geojson",
        "Geojson/Resturant_cleaned.geojson",
        "Geojson/MousqesTabeFull.geojson",
        "Geojson/Metro_Final.geojson",
        "Geojson/Hospital_full.geojson",
        "Geojson/Full_hotel.geojson",
        "Geojson/Full_entr.geojson",
        "Geojson/Full_cafe.geojson",
        "Geojson/FinalMusem.geojson"
    ];

    const loadingEl = document.getElementById("loading");
    const searchInput = document.getElementById("search-input");
    const categorySelect = document.getElementById("category-select");
    const regionSelect = document.getElementById("region-select");
    const resetBtn = document.getElementById("reset-filters");
    const placesListEl = document.getElementById("places-list");
    const placesCountEl = document.getElementById("places-count");

    const modeLocalBtn = document.getElementById("mode-local");
    const modeGlobalBtn = document.getElementById("mode-global");
    const localFiltersEl = document.getElementById("local-filters");
    const globalSearchContainer = document.getElementById("global-search-container");
    const globalSearchInput = document.getElementById("global-search-input");
    const globalSearchResults = document.getElementById("global-search-results");

    let allFeatures = [];    // ÙƒÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø£ØµÙ„ÙŠØ©
    let filteredFeatures = []; // Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„Ø§ØªØ±
    let map;                 // ÙƒØ§Ø¦Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©

    // --------- Category Normalization ----------
    function normalizeCategory(cat) {
        if (!cat) return "";

        cat = cat.trim().toLowerCase();

        // Main direct categories
        if (cat === "bus") return "Bus";
        if (cat === "restaurant" || cat === "resturant") return "Restaurant";
        if (cat === "cafe") return "Cafe";
        if (cat === "hotel") return "Hotel";
        if (cat === "hospital") return "Hospital";
        if (cat === "mosque" || cat === "mousqe" || cat === "shrine") return "Mosque";
        if (cat === "metro") return "Metro";
        if (cat === "entertainment") return "Entertainment";

        // Museum family â€” Ø£ÙŠ Ù†ÙˆØ¹ Ù…ØªØ­Ù â†’ Museum
        if (
            cat.includes("museum") ||
            cat.includes("historical") ||
            cat.includes("heritage") ||
            cat.includes("zoology") ||
            cat.includes("tourist") ||
            cat.includes("art") ||
            cat.includes("archaeological") ||
            cat.includes("natural") ||
            cat.includes("history")
        ) {
            return "Museum";
        }

        // Default fallback â†’ Museum (Ø£Ù‚Ø±Ø¨ Ø´ÙŠØ¡)
        return "Museum";
    }

    // --------- Load GeoJSON ----------
    async function loadAllGeoJSON() {
        let merged = { type: "FeatureCollection", features: [] };
        let loaded = 0;

        for (const path of GEOJSON_FILES) {
            try {
                const res = await fetch(path);
                if (!res.ok) {
                    console.warn("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„:", path, res.status);
                    continue;
                }
                const json = await res.json();
                if (json && Array.isArray(json.features)) {
                    merged.features.push(...json.features);
                    loaded++;
                }
            } catch (err) {
                console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„:", path, err);
            }
        }

        console.log("Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ù…Ù‘Ù„Ø©:", loaded);

        // Ø¬Ù‡Ù‘Ø² Ø®Ø§ØµÙŠØ© category Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© Ù„ÙƒÙ„ feature
        merged.features.forEach(f => {
            const p = f.properties || {};
            p._categoryNorm = normalizeCategory(p.category);
        });

        return merged;
    }

    // --------- Build dropdown options ----------
    function buildFilterOptions(features) {
        const categories = new Set();
        const regions = new Set();

        features.forEach(f => {
            const p = f.properties || {};

            const fixedCat = p._categoryNorm || "";
            if (fixedCat) categories.add(fixedCat);

            if (p.region && p.region.trim() !== "") {
                regions.add(p.region.trim());
            }
        });

        // Reset dropdowns
        categorySelect.innerHTML = "<option value=''>ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>";
        regionSelect.innerHTML = "<option value=''>ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>";

        Array.from(categories)
            .sort((a, b) => a.localeCompare(b))
            .forEach(cat => {
                const opt = document.createElement("option");
                opt.value = cat;
                opt.textContent = cat;
                categorySelect.appendChild(opt);
            });

        Array.from(regions)
            .sort((a, b) => a.localeCompare(b))
            .forEach(reg => {
                const opt = document.createElement("option");
                opt.value = reg;
                opt.textContent = reg;
                regionSelect.appendChild(opt);
            });
    }

    // --------- Local filters ----------
    function applyFilters() {
        const text = searchInput.value.trim().toLowerCase();
        const selectedCat = categorySelect.value;
        const selectedRegion = regionSelect.value;

        filteredFeatures = allFeatures.filter(f => {
            const p = f.properties || {};
            const name = (p.name || p.Name || "").toLowerCase();
            const catNorm = p._categoryNorm || "";
            const reg = p.region || "";

            if (text && !name.includes(text)) return false;
            if (selectedCat && catNorm !== selectedCat) return false;
            if (selectedRegion && reg !== selectedRegion) return false;

            return true;
        });

        const src = map.getSource("places");
        if (src) {
            src.setData({
                type: "FeatureCollection",
                features: filteredFeatures
            });
        }

        renderSidebarList(filteredFeatures);
        placesCountEl.textContent = `${filteredFeatures.length} Ù…ÙƒØ§Ù†`;

        if (filteredFeatures.length > 0) {
            const coords = filteredFeatures
                .filter(f => f.geometry && Array.isArray(f.geometry.coordinates))
                .map(f => f.geometry.coordinates);

            if (coords.length > 0) {
                const bounds = coords.reduce(
                    (b, c) => b.extend(c),
                    new maplibregl.LngLatBounds(coords[0], coords[0])
                );
                map.fitBounds(bounds, { padding: 40, maxZoom: 12 });
            }
        }
    }

    function renderSidebarList(features) {
        placesListEl.innerHTML = "";

        features.forEach((f, index) => {
            const p = f.properties || {};
            const name = p.name || p.Name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
            const cat = p._categoryNorm || "";
            const reg = p.region || "";
            const rating = p.rating;

            const div = document.createElement("div");
            div.className = "place-item";
            div.dataset.index = index;

            div.innerHTML = `
                <h3 class="place-title">${name}</h3>
                <div class="place-meta">
                    ${cat ? `<span>ğŸ“Œ ${cat}</span>` : ""}
                    ${reg ? `<span>ğŸ“ ${reg}</span>` : ""}
                    ${rating ? `<span>â­ ${rating}</span>` : ""}
                </div>
            `;

            div.addEventListener("click", () => {
                const coords = f.geometry && f.geometry.coordinates;
                if (!coords) return;

                document.querySelectorAll(".place-item").forEach(el => el.classList.remove("active"));
                div.classList.add("active");

                map.easeTo({ center: coords, zoom: 16 });

                const html = `
                    <div>
                        <h3 style="margin:0 0 6px 0;">${name}</h3>
                        ${cat ? `<p style="margin:0;"><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${cat}</p>` : ""}
                        ${reg ? `<p style="margin:0;"><strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> ${reg}</p>` : ""}
                        ${rating ? `<p style="margin:0;"><strong>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</strong> â­ ${rating}</p>` : ""}
                    </div>
                `;

                new maplibregl.Popup()
                    .setLngLat(coords)
                    .setHTML(html)
                    .addTo(map);
            });

            placesListEl.appendChild(div);
        });
    }

    // --------- Global Photon Search (no plugin, direct API) ----------
    async function doGlobalSearch(query) {
        globalSearchResults.innerHTML = "";
        if (!query || query.trim().length < 3) {
            return;
        }

        const url = "https://photon.komoot.io/api/?q=" + encodeURIComponent(query) + "&lang=en&limit=6";

        try {
            const res = await fetch(url);
            if (!res.ok) {
                console.error("Photon error:", res.status);
                return;
            }
            const data = await res.json();
            const features = data.features || [];

            features.forEach(feat => {
                const props = feat.properties || {};
                const [lon, lat] = feat.geometry.coordinates;

                const div = document.createElement("div");
                div.className = "global-result-item";

                const title = props.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
                const city = props.city || props.locality || "";
                const country = props.country || "";

                div.innerHTML = `
                    <p class="global-result-title">${title}</p>
                    <p class="global-result-meta">
                        ${city ? city + " - " : ""}${country}
                    </p>
                `;

                div.addEventListener("click", () => {
                    map.easeTo({
                        center: [lon, lat],
                        zoom: 14
                    });

                    new maplibregl.Popup()
                        .setLngLat([lon, lat])
                        .setHTML(`
                            <div>
                                <h3 style="margin:0 0 6px 0;">${title}</h3>
                                ${city ? `<p style="margin:0;">${city}</p>` : ""}
                                ${country ? `<p style="margin:0;">${country}</p>` : ""}
                            </div>
                        `)
                        .addTo(map);
                });

                globalSearchResults.appendChild(div);
            });

        } catch (err) {
            console.error("Photon fetch error:", err);
        }
    }

    // --------- Map Init ----------
    map = new maplibregl.Map({
        container: "map",
        style: "https://tiles.openfreemap.org/styles/bright",
        center: [44.5, 24.5],
        zoom: 5
    });

    map.addControl(new maplibregl.NavigationControl(), "top-left");

    map.on("load", async () => {
        const merged = await loadAllGeoJSON();

        allFeatures = merged.features || [];
        filteredFeatures = [...allFeatures];

        // Ù…ØµØ¯Ø± Ù…Ø¹ clustering
        map.addSource("places", {
            type: "geojson",
            data: merged,
            cluster: true,
            clusterMaxZoom: 14,
            clusterRadius: 45
        });

        // Ø·Ø¨Ù‚Ø© Ø§Ù„ÙƒÙ„Ø³ØªØ±
        map.addLayer({
            id: "clusters",
            type: "circle",
            source: "places",
            filter: ["has", "point_count"],
            paint: {
                "circle-color": [
                    "step",
                    ["get", "point_count"],
                    "#51bbd6",
                    30, "#f1f075",
                    150, "#f28cb1"
                ],
                "circle-radius": [
                    "step",
                    ["get", "point_count"],
                    16,
                    30, 22,
                    150, 30
                ],
                "circle-stroke-width": 1,
                "circle-stroke-color": "#ffffff"
            }
        });

        // Ø±Ù‚Ù… Ø§Ù„ÙƒÙ„Ø³ØªØ±
        map.addLayer({
            id: "cluster-count",
            type: "symbol",
            source: "places",
            filter: ["has", "point_count"],
            layout: {
                "text-field": "{point_count_abbreviated}",
                "text-size": 12
            },
            paint: {
                "text-color": "#000"
            }
        });

        // Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ÙØ±Ø¯ÙŠØ©
        map.addLayer({
            id: "unclustered-point",
            type: "circle",
            source: "places",
            filter: ["!", ["has", "point_count"]],
            paint: {
                "circle-radius": 6,
                "circle-stroke-width": 1,
                "circle-stroke-color": "#ffffff",
                "circle-color": [
                    "match",
                    ["get", "_categoryNorm"],
                    "Restaurant", "#e74c3c",
                    "Cafe", "#f7931e",
                    "Hotel", "#3498db",
                    "Hospital", "#e91e63",
                    "Metro", "#9b59b6",
                    "Mosque", "#006233",
                    "Bus", "#1abc9c",
                    "Entertainment", "#16a085",
                    "Museum", "#8e44ad",
                    /* default */ "#666666"
                ]
            }
        });

        // Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ù…Ø§ÙƒÙ†
        map.addLayer({
            id: "point-labels",
            type: "symbol",
            source: "places",
            filter: ["!", ["has", "point_count"]],
            layout: {
                "text-field": ["coalesce", ["get", "name"], ["get", "Name"], ""],
                "text-size": 11,
                "text-anchor": "top",
                "text-offset": [0, -1.1]
            },
            paint: {
                "text-color": "#006233",
                "text-halo-color": "#ffffff",
                "text-halo-width": 1.5
            }
        });

        // ØªÙƒØ¨ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø³ØªØ±
        map.on("click", "clusters", (e) => {
            const features = map.queryRenderedFeatures(e.point, { layers: ["clusters"] });
            const clusterId = features[0].properties.cluster_id;
            map.getSource("places").getClusterExpansionZoom(clusterId, (err, zoom) => {
                if (err) return;
                map.easeTo({
                    center: features[0].geometry.coordinates,
                    zoom: zoom
                });
            });
        });

        // Ø¨ÙˆØ¨ Ø£Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ù†Ù‚Ø·Ø©
        map.on("click", "unclustered-point", (e) => {
            const f = e.features[0];
            const p = f.properties || {};
            const coords = f.geometry.coordinates;
            const name = p.name || p.Name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
            const cat = p._categoryNorm || "";
            const reg = p.region || "";
            const rating = p.rating;

            const html = `
                <div>
                    <h3 style="margin:0 0 6px 0;">${name}</h3>
                    ${cat ? `<p style="margin:0;"><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${cat}</p>` : ""}
                    ${reg ? `<p style="margin:0;"><strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> ${reg}</p>` : ""}
                    ${rating ? `<p style="margin:0;"><strong>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</strong> â­ ${rating}</p>` : ""}
                </div>
            `;

            new maplibregl.Popup()
                .setLngLat(coords)
                .setHTML(html)
                .addTo(map);
        });

        map.on("mouseenter", "unclustered-point", () => {
            map.getCanvas().style.cursor = "pointer";
        });
        map.on("mouseleave", "unclustered-point", () => {
            map.getCanvas().style.cursor = "";
        });

        // Ø¨Ù†Ø§Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø©
        buildFilterOptions(allFeatures);
        renderSidebarList(allFeatures);
        placesCountEl.textContent = `${allFeatures.length} Ù…ÙƒØ§Ù†`;

        // Ø¶Ø¨Ø· Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
        if (allFeatures.length > 0) {
            const coords = allFeatures
                .filter(f => f.geometry && Array.isArray(f.geometry.coordinates))
                .map(f => f.geometry.coordinates);

            if (coords.length > 0) {
                const bounds = coords.reduce(
                    (b, c) => b.extend(c),
                    new maplibregl.LngLatBounds(coords[0], coords[0])
                );
                map.fitBounds(bounds, { padding: 40, maxZoom: 12 });
            }
        }

        loadingEl.style.display = "none";
    });

    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙÙ„Ø§ØªØ± (Ù…Ø­Ù„ÙŠ)
    searchInput.addEventListener("input", () => applyFilters());
    categorySelect.addEventListener("change", () => applyFilters());
    regionSelect.addEventListener("change", () => applyFilters());

    resetBtn.addEventListener("click", () => {
        searchInput.value = "";
        categorySelect.value = "";
        regionSelect.value = "";
        applyFilters();
    });

    // ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ÙˆØ¶Ø¹ A (Ù…Ø­Ù„ÙŠ) Ùˆ B (Photon Ø¹Ø§Ù„Ù…ÙŠ)
    modeLocalBtn.addEventListener("click", () => {
        modeLocalBtn.classList.add("active");
        modeGlobalBtn.classList.remove("active");
        localFiltersEl.style.display = "grid";
        document.getElementById("places-list").style.display = "block";
        globalSearchContainer.style.display = "none";
        placesCountEl.style.display = "block";
    });

    modeGlobalBtn.addEventListener("click", () => {
        modeGlobalBtn.classList.add("active");
        modeLocalBtn.classList.remove("active");
        localFiltersEl.style.display = "none";
        document.getElementById("places-list").style.display = "none";
        placesCountEl.style.display = "none";
        globalSearchContainer.style.display = "block";
        globalSearchInput.focus();
    });

    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø©
    let globalSearchTimeout = null;
    globalSearchInput.addEventListener("input", () => {
        const q = globalSearchInput.value;
        globalSearchResults.innerHTML = "";
        if (globalSearchTimeout) clearTimeout(globalSearchTimeout);
        globalSearchTimeout = setTimeout(() => {
            doGlobalSearch(q);
        }, 400);
    });
</script>

</body>
</html>
